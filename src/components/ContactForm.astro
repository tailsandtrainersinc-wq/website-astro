---
import { SITE } from "../config/site.mjs";

const web3formsAccessKey = (SITE.web3formsAccessKey || "").trim();
const googleSheetsScriptUrl = (SITE.googleSheetsScriptUrl || "").trim();
const useGoogleSheets = googleSheetsScriptUrl.length > 0;
const useWeb3Forms = web3formsAccessKey.length > 0;
const formConfigured = useGoogleSheets || useWeb3Forms;
---

<div
  class="rounded-3xl border p-6 md:p-10"
  style="background: var(--surface-mid); border-color: oklch(0.25 0.02 280 / 0.4);"
>
  <form
    id="contact-form"
    aria-label="Contact form"
    novalidate
    action={useWeb3Forms ? "https://api.web3forms.com/submit" : "#"}
    method="POST"
    data-google-sheets-url={googleSheetsScriptUrl}
    data-web3forms-key={web3formsAccessKey}
  >
    {useWeb3Forms && (
      <>
        <input type="hidden" name="access_key" value={web3formsAccessKey} />
        <input type="hidden" name="subject" value="Tails and Trainers - Contact Form" />
        <input type="hidden" name="redirect" value="false" />
      </>
    )}
    <!-- Honeypot spam protection -->
    <input type="checkbox" name="botcheck" class="hidden" style="display: none;" tabindex="-1" autocomplete="off" />

    <!-- Success Message -->
    <div
      id="success-message"
      class="hidden mb-6 p-5 rounded-2xl"
      role="alert"
      aria-live="polite"
      style="background: oklch(0.60 0.15 145 / 0.12); border: 1px solid oklch(0.60 0.15 145 / 0.25); color: oklch(0.80 0.10 145);"
    >
      <p class="font-medium">Thank you for your message!</p>
      <p class="text-sm mt-1 opacity-80">We'll get back to you soon.</p>
    </div>

    <!-- Error Message -->
    <div
      id="error-message"
      class="hidden mb-6 p-5 rounded-2xl"
      role="alert"
      aria-live="assertive"
      style="background: oklch(0.55 0.20 25 / 0.12); border: 1px solid oklch(0.55 0.20 25 / 0.25); color: oklch(0.80 0.12 25);"
    >
      <p class="font-medium" id="error-text"></p>
    </div>

    <!-- Name Field -->
    <div class="field-group">
      <input
        type="text"
        id="name"
        name="from_name"
        class="field-underline"
        placeholder="Name"
        required
        aria-required="true"
        aria-describedby="name-error"
        autocomplete="name"
      />
      <label for="name" class="field-label">
        Name <span style="color: var(--accent-warm);" aria-label="required">*</span>
      </label>
      <span
        id="name-error"
        class="mt-2 text-sm hidden block"
        role="alert"
        aria-live="polite"
        style="color: var(--accent-hot);"
      ></span>
    </div>

    <!-- Email Field -->
    <div class="field-group">
      <input
        type="email"
        id="email"
        name="from_email"
        class="field-underline"
        placeholder="Email"
        required
        aria-required="true"
        aria-describedby="email-error"
        autocomplete="email"
      />
      <label for="email" class="field-label">
        Email <span style="color: var(--accent-warm);" aria-label="required">*</span>
      </label>
      <span
        id="email-error"
        class="mt-2 text-sm hidden block"
        role="alert"
        aria-live="polite"
        style="color: var(--accent-hot);"
      ></span>
    </div>

    <!-- Message Field -->
    <div class="field-group">
      <textarea
        id="message"
        name="message"
        rows="5"
        class="field-underline resize-none"
        placeholder="Message"
        required
        aria-required="true"
        aria-describedby="message-error"
      ></textarea>
      <label for="message" class="field-label">
        Message <span style="color: var(--accent-warm);" aria-label="required">*</span>
      </label>
      <span
        id="message-error"
        class="mt-2 text-sm hidden block"
        role="alert"
        aria-live="polite"
        style="color: var(--accent-hot);"
      ></span>
    </div>

    <!-- Submit Button -->
    <button
      type="submit"
      id="submit-button"
      class="btn-primary w-full mt-4 py-4 text-base font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
      style="focus: ring-offset-color: var(--surface-mid);"
    >
      <span id="submit-text">Send Message</span>
      <span id="submit-loading" class="hidden">Sending...</span>
    </button>
  </form>
</div>

<script>
  const form = document.getElementById("contact-form") as HTMLFormElement;
  const submitButton = document.getElementById("submit-button") as HTMLButtonElement;
  const submitText = document.getElementById("submit-text") as HTMLSpanElement;
  const submitLoading = document.getElementById("submit-loading") as HTMLSpanElement;
  const successMessage = document.getElementById("success-message") as HTMLDivElement;
  const errorMessage = document.getElementById("error-message") as HTMLDivElement;
  const errorText = document.getElementById("error-text") as HTMLParagraphElement;

  // Field elements
  const nameInput = document.getElementById("name") as HTMLInputElement;
  const emailInput = document.getElementById("email") as HTMLInputElement;
  const messageInput = document.getElementById("message") as HTMLTextAreaElement;
  const nameError = document.getElementById("name-error") as HTMLSpanElement;
  const emailError = document.getElementById("email-error") as HTMLSpanElement;
  const messageError = document.getElementById("message-error") as HTMLSpanElement;

  // Validation functions
  function validateEmail(email: string): boolean {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function showFieldError(field: HTMLInputElement | HTMLTextAreaElement, errorElement: HTMLSpanElement, message: string) {
    field.setAttribute("aria-invalid", "true");
    field.style.borderBottomColor = "var(--accent-hot)";
    errorElement.textContent = message;
    errorElement.classList.remove("hidden");
  }

  function clearFieldError(field: HTMLInputElement | HTMLTextAreaElement, errorElement: HTMLSpanElement) {
    field.setAttribute("aria-invalid", "false");
    field.style.borderBottomColor = "";
    errorElement.classList.add("hidden");
    errorElement.textContent = "";
  }

  function hideAllMessages() {
    successMessage.classList.add("hidden");
    errorMessage.classList.add("hidden");
  }

  function setLoading(loading: boolean) {
    submitButton.disabled = loading;
    if (loading) {
      submitText.classList.add("hidden");
      submitLoading.classList.remove("hidden");
    } else {
      submitText.classList.remove("hidden");
      submitLoading.classList.add("hidden");
    }
  }

  // Real-time validation
  nameInput.addEventListener("blur", () => {
    const value = nameInput.value.trim();
    if (!value) {
      showFieldError(nameInput, nameError, "Name is required");
    } else if (value.length < 2) {
      showFieldError(nameInput, nameError, "Name must be at least 2 characters");
    } else {
      clearFieldError(nameInput, nameError);
    }
  });

  emailInput.addEventListener("blur", () => {
    const value = emailInput.value.trim();
    if (!value) {
      showFieldError(emailInput, emailError, "Email is required");
    } else if (!validateEmail(value)) {
      showFieldError(emailInput, emailError, "Please enter a valid email address");
    } else {
      clearFieldError(emailInput, emailError);
    }
  });

  messageInput.addEventListener("blur", () => {
    const value = messageInput.value.trim();
    if (!value) {
      showFieldError(messageInput, messageError, "Message is required");
    } else if (value.length < 10) {
      showFieldError(messageInput, messageError, "Message must be at least 10 characters");
    } else {
      clearFieldError(messageInput, messageError);
    }
  });

  // Form backend: Google Sheets (Apps Script) or Web3Forms
  const googleSheetsUrl = form.dataset.googleSheetsUrl?.trim() || "";
  const hasGoogleSheets = googleSheetsUrl.length > 0;
  const hasWeb3Forms = (form.querySelector('input[name="access_key"]') as HTMLInputElement)?.value?.trim()?.length > 0;
  const formConfigured = hasGoogleSheets || hasWeb3Forms;

  if (!formConfigured) {
    const warningDiv = document.createElement("div");
    warningDiv.className = "mb-6 p-5 rounded-2xl text-sm";
    warningDiv.style.cssText = "background: oklch(0.80 0.15 85 / 0.08); border: 1px solid oklch(0.80 0.15 85 / 0.2); color: oklch(0.80 0.10 85);";
    warningDiv.innerHTML = `
      <p class="font-medium mb-1">Form not configured</p>
      <p class="opacity-80">Add either <strong>Google Sheets</strong> or a <strong>Web3Forms</strong> access key in <code style="background: var(--surface-raised); padding: 0.125rem 0.375rem; border-radius: 0.25rem;">src/config/site.mjs</code>.</p>
    `;
    form.insertBefore(warningDiv, form.firstChild);
  }

  // Form submission
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    hideAllMessages();

    if (!formConfigured) {
      errorText.textContent = "Form is not configured. Please contact the site administrator.";
      errorMessage.classList.remove("hidden");
      errorMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
      return;
    }

    // Clear previous errors
    clearFieldError(nameInput, nameError);
    clearFieldError(emailInput, emailError);
    clearFieldError(messageInput, messageError);

    // Validate all fields
    let isValid = true;

    if (!nameInput.value.trim()) {
      showFieldError(nameInput, nameError, "Name is required");
      isValid = false;
    }

    if (!emailInput.value.trim()) {
      showFieldError(emailInput, emailError, "Email is required");
      isValid = false;
    } else if (!validateEmail(emailInput.value.trim())) {
      showFieldError(emailInput, emailError, "Please enter a valid email address");
      isValid = false;
    }

    if (!messageInput.value.trim()) {
      showFieldError(messageInput, messageError, "Message is required");
      isValid = false;
    } else if (messageInput.value.trim().length < 10) {
      showFieldError(messageInput, messageError, "Message must be at least 10 characters");
      isValid = false;
    }

    if (!isValid) {
      const firstError = form.querySelector('[aria-invalid="true"]') as HTMLElement;
      if (firstError) {
        firstError.focus();
      }
      return;
    }

    setLoading(true);

    try {
      const formData = new FormData(form);
      const submitUrl = hasGoogleSheets ? googleSheetsUrl : "https://api.web3forms.com/submit";

      const response = await fetch(submitUrl, {
        method: "POST",
        body: formData,
      });

      let data: { success?: boolean; message?: string };
      try {
        data = await response.json();
      } catch {
        data = {};
      }

      if (response.ok && data.success) {
        successMessage.classList.remove("hidden");
        form.reset();
        successMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
      } else {
        errorText.textContent = data.message || "Failed to send message. Please try again.";
        errorMessage.classList.remove("hidden");
        errorMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    } catch (error) {
      errorText.textContent = "Network error. Please check your connection and try again.";
      errorMessage.classList.remove("hidden");
      errorMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
    } finally {
      setLoading(false);
    }
  });
</script>

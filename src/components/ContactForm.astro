---
import { SITE } from "../config/site.mjs";

const web3formsAccessKey = (SITE.web3formsAccessKey || "").trim();
const googleSheetsScriptUrl = (SITE.googleSheetsScriptUrl || "").trim();
const useGoogleSheets = googleSheetsScriptUrl.length > 0;
const useWeb3Forms = web3formsAccessKey.length > 0;
const formConfigured = useGoogleSheets || useWeb3Forms;
---

<form
  id="contact-form"
  class="space-y-8"
  aria-label="Contact form"
  novalidate
  action={useWeb3Forms ? "https://api.web3forms.com/submit" : "#"}
  method="POST"
  data-google-sheets-url={googleSheetsScriptUrl}
  data-web3forms-key={web3formsAccessKey}
>
  {useWeb3Forms && (
    <>
      <input type="hidden" name="access_key" value={web3formsAccessKey} />
      <input type="hidden" name="subject" value="Tails and Trainers - Contact Form" />
      <input type="hidden" name="redirect" value="false" />
    </>
  )}
  <!-- Honeypot spam protection -->
  <input type="checkbox" name="botcheck" class="hidden" style="display: none;" tabindex="-1" autocomplete="off" />

  <!-- Success Message -->
  <div
    id="success-message"
    class="hidden p-4 bg-emerald-500/15 border border-emerald-500/30 rounded-lg text-emerald-300"
    role="alert"
    aria-live="polite"
  >
    <p class="font-medium">Thank you for your message!</p>
    <p class="text-sm mt-1 opacity-80">We'll get back to you soon.</p>
  </div>

  <!-- Error Message -->
  <div
    id="error-message"
    class="hidden p-4 bg-oxblood/20 border border-oxblood/40 rounded-lg text-[#E8A0A0]"
    role="alert"
    aria-live="assertive"
  >
    <p class="font-medium" id="error-text"></p>
  </div>

  <!-- Name Field (floating label) -->
  <div class="field-group">
    <input
      type="text"
      id="name"
      name="from_name"
      class="field-underline"
      required
      aria-required="true"
      aria-describedby="name-error"
      autocomplete="name"
      placeholder=" "
    />
    <label for="name" class="field-label">
      Name <span class="text-brass" aria-label="required">*</span>
    </label>
    <span
      id="name-error"
      class="mt-1 text-sm text-oxblood hidden"
      role="alert"
      aria-live="polite"
    ></span>
  </div>

  <!-- Email Field (floating label) -->
  <div class="field-group">
    <input
      type="email"
      id="email"
      name="from_email"
      class="field-underline"
      required
      aria-required="true"
      aria-describedby="email-error"
      autocomplete="email"
      placeholder=" "
    />
    <label for="email" class="field-label">
      Email <span class="text-brass" aria-label="required">*</span>
    </label>
    <span
      id="email-error"
      class="mt-1 text-sm text-oxblood hidden"
      role="alert"
      aria-live="polite"
    ></span>
  </div>

  <!-- Message Field -->
  <div>
    <label for="message" class="block text-sm font-medium text-taupe mb-2">
      Message <span class="text-brass" aria-label="required">*</span>
    </label>
    <textarea
      id="message"
      name="message"
      rows="6"
      class="field-underline"
      required
      aria-required="true"
      aria-describedby="message-error"
    ></textarea>
    <span
      id="message-error"
      class="mt-1 text-sm text-oxblood hidden"
      role="alert"
      aria-live="polite"
    ></span>
  </div>

  <!-- Submit Button -->
  <button
    type="submit"
    id="submit-button"
    class="btn-primary btn-wag w-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-leather-deep focus:ring-brass disabled:opacity-50 disabled:cursor-not-allowed"
  >
    <span id="submit-text">Send Message</span>
    <span id="submit-loading" class="hidden">Sending...</span>
  </button>
</form>

<script>
  const form = document.getElementById("contact-form") as HTMLFormElement;
  const submitButton = document.getElementById("submit-button") as HTMLButtonElement;
  const submitText = document.getElementById("submit-text") as HTMLSpanElement;
  const submitLoading = document.getElementById("submit-loading") as HTMLSpanElement;
  const successMessage = document.getElementById("success-message") as HTMLDivElement;
  const errorMessage = document.getElementById("error-message") as HTMLDivElement;
  const errorText = document.getElementById("error-text") as HTMLParagraphElement;

  const nameInput = document.getElementById("name") as HTMLInputElement;
  const emailInput = document.getElementById("email") as HTMLInputElement;
  const messageInput = document.getElementById("message") as HTMLTextAreaElement;
  const nameError = document.getElementById("name-error") as HTMLSpanElement;
  const emailError = document.getElementById("email-error") as HTMLSpanElement;
  const messageError = document.getElementById("message-error") as HTMLSpanElement;

  function validateEmail(email: string): boolean {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function showFieldError(field: HTMLInputElement | HTMLTextAreaElement, errorElement: HTMLSpanElement, message: string) {
    field.setAttribute("aria-invalid", "true");
    errorElement.textContent = message;
    errorElement.classList.remove("hidden");
  }

  function clearFieldError(field: HTMLInputElement | HTMLTextAreaElement, errorElement: HTMLSpanElement) {
    field.setAttribute("aria-invalid", "false");
    errorElement.classList.add("hidden");
    errorElement.textContent = "";
  }

  function hideAllMessages() {
    successMessage.classList.add("hidden");
    errorMessage.classList.add("hidden");
  }

  function setLoading(loading: boolean) {
    submitButton.disabled = loading;
    if (loading) {
      submitText.classList.add("hidden");
      submitLoading.classList.remove("hidden");
    } else {
      submitText.classList.remove("hidden");
      submitLoading.classList.add("hidden");
    }
  }

  nameInput.addEventListener("blur", () => {
    const value = nameInput.value.trim();
    if (!value) {
      showFieldError(nameInput, nameError, "Name is required");
    } else if (value.length < 2) {
      showFieldError(nameInput, nameError, "Name must be at least 2 characters");
    } else {
      clearFieldError(nameInput, nameError);
    }
  });

  emailInput.addEventListener("blur", () => {
    const value = emailInput.value.trim();
    if (!value) {
      showFieldError(emailInput, emailError, "Email is required");
    } else if (!validateEmail(value)) {
      showFieldError(emailInput, emailError, "Please enter a valid email address");
    } else {
      clearFieldError(emailInput, emailError);
    }
  });

  messageInput.addEventListener("blur", () => {
    const value = messageInput.value.trim();
    if (!value) {
      showFieldError(messageInput, messageError, "Message is required");
    } else if (value.length < 10) {
      showFieldError(messageInput, messageError, "Message must be at least 10 characters");
    } else {
      clearFieldError(messageInput, messageError);
    }
  });

  const googleSheetsUrl = form.dataset.googleSheetsUrl?.trim() || "";
  const hasGoogleSheets = googleSheetsUrl.length > 0;
  const hasWeb3Forms = (form.querySelector('input[name="access_key"]') as HTMLInputElement)?.value?.trim()?.length > 0;
  const formConfigured = hasGoogleSheets || hasWeb3Forms;

  if (!formConfigured) {
    const warningDiv = document.createElement("div");
    warningDiv.className = "p-4 bg-brass/15 border border-brass/30 rounded-lg text-brass text-sm";
    warningDiv.innerHTML = `
      <p class="font-medium mb-1">Form not configured</p>
      <p class="text-taupe">Add either <strong>Google Sheets</strong> (see <code class="bg-leather-raised px-1 rounded">docs/google-sheets-form-setup.md</code>) or a <strong>Web3Forms</strong> access key in <code class="bg-leather-raised px-1 rounded">src/config/site.mjs</code>.</p>
    `;
    form.insertBefore(warningDiv, form.firstChild);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    hideAllMessages();

    if (!formConfigured) {
      errorText.textContent = "Form is not configured. Please contact the site administrator.";
      errorMessage.classList.remove("hidden");
      errorMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
      return;
    }

    clearFieldError(nameInput, nameError);
    clearFieldError(emailInput, emailError);
    clearFieldError(messageInput, messageError);

    let isValid = true;

    if (!nameInput.value.trim()) {
      showFieldError(nameInput, nameError, "Name is required");
      isValid = false;
    }

    if (!emailInput.value.trim()) {
      showFieldError(emailInput, emailError, "Email is required");
      isValid = false;
    } else if (!validateEmail(emailInput.value.trim())) {
      showFieldError(emailInput, emailError, "Please enter a valid email address");
      isValid = false;
    }

    if (!messageInput.value.trim()) {
      showFieldError(messageInput, messageError, "Message is required");
      isValid = false;
    } else if (messageInput.value.trim().length < 10) {
      showFieldError(messageInput, messageError, "Message must be at least 10 characters");
      isValid = false;
    }

    if (!isValid) {
      const firstError = form.querySelector('[aria-invalid="true"]') as HTMLElement;
      if (firstError) {
        firstError.focus();
      }
      return;
    }

    setLoading(true);

    try {
      const formData = new FormData(form);
      const submitUrl = hasGoogleSheets ? googleSheetsUrl : "https://api.web3forms.com/submit";

      const response = await fetch(submitUrl, {
        method: "POST",
        body: formData,
      });

      let data: { success?: boolean; message?: string };
      try {
        data = await response.json();
      } catch {
        data = {};
      }

      if (response.ok && data.success) {
        successMessage.classList.remove("hidden");
        form.reset();
        successMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
      } else {
        errorText.textContent = data.message || "Failed to send message. Please try again.";
        errorMessage.classList.remove("hidden");
        errorMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    } catch (error) {
      errorText.textContent = "Network error. Please check your connection and try again.";
      errorMessage.classList.remove("hidden");
      errorMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
    } finally {
      setLoading(false);
    }
  });
</script>
